<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB 輸入範例</title>
</head>
<body>
    <h1>操作記錄範例</h1>
    <form id="inputForm">
        <label for="content">內容:</label>
        <input type="text" id="content" name="content" required>
        <br><br>
        <button type="submit">提交</button>
    </form>
    <button onclick="exportDatabase()">匯出所有操作記錄</button>
    <button onclick="clearDatabase()">清除所有操作記錄</button>
    <h2>歷史記錄</h2>
    <ul id="historyList"></ul>

    <script>
        let db;
        const sessionKey = new Date().toISOString(); // 使用 const 來定義 sessionKey
        let round = 1;
        const retentionDays = 7; // 設定資料保留天數

        // 開啟資料庫
        function openDatabase() {
            let request = indexedDB.open('OperationsDB', 1);

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains('Records')) {
                    db.createObjectStore('Records', { keyPath: 'sessionKey' });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('資料庫開啟成功');
                deleteOldRecords();
                displayHistory();
            };

            request.onerror = function(event) {
                console.error('資料庫錯誤: ' + event.target.errorCode);
            };
        }

        openDatabase();

        // 新增操作記錄
        function addOperation(content) {
            let transaction = db.transaction(['Records'], 'readwrite');
            let objectStore = transaction.objectStore('Records');
            let getRequest = objectStore.get(sessionKey);

            getRequest.onsuccess = function(event) {
                let sessionData = event.target.result || { sessionKey: sessionKey, operations: [] };
                let newOperation = {
                    round: round,
                    content: content,
                    timestamp: new Date()
                };
                sessionData.operations.push(newOperation);
                round++; // 自動增加 round 計數
                let putRequest = objectStore.put(sessionData);

                putRequest.onsuccess = function(event) {
                    console.log('操作記錄新增成功');
                    displayHistory(); // 新增成功後更新顯示
                };

                putRequest.onerror = function(event) {
                    console.error('新增操作記錄錯誤: ' + event.target.errorCode);
                };
            };

            getRequest.onerror = function(event) {
                console.error('獲取 session 資料錯誤: ' + event.target.errorCode);
            };
        }

        // 表單提交事件處理
        document.getElementById('inputForm').addEventListener('submit', function(event) {
            event.preventDefault();
            let content = document.getElementById('content').value;
            addOperation(content);
            document.getElementById('content').value = ''; // 清空輸入框
        });

        // 匯出資料
        function exportDatabase() {
            let transaction = db.transaction(['Records'], 'readonly');
            let objectStore = transaction.objectStore('Records');
            let allRecords = [];

            objectStore.openCursor().onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    allRecords.push(cursor.value);
                    cursor.continue();
                } else {
                    let dataStr = JSON.stringify(allRecords, null, 2);
                    let dataBlob = new Blob([dataStr], { type: 'application/json' });
                    let url = URL.createObjectURL(dataBlob);

                    let link = document.createElement('a');
                    link.href = url;
                    link.download = 'operations.json';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    console.log('匯出完成');
                }
            };

            objectStore.openCursor().onerror = function(event) {
                console.error('匯出錯誤: ' + event.target.errorCode);
            };
        }

        // 清除資料庫
        function clearDatabase() {
            let transaction = db.transaction(['Records'], 'readwrite');
            let objectStore = transaction.objectStore('Records');
            let clearRequest = objectStore.clear();

            clearRequest.onsuccess = function(event) {
                console.log('所有操作記錄已清除');
                displayHistory(); // 清除後更新顯示
            };

            clearRequest.onerror = function(event) {
                console.error('清除操作記錄錯誤: ' + event.target.errorCode);
            };
        }

        // 刪除過期資料
        function deleteOldRecords() {
            let transaction = db.transaction(['Records'], 'readwrite');
            let objectStore = transaction.objectStore('Records');
            let currentDate = new Date();

            objectStore.openCursor().onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    let recordDate = new Date(cursor.value.sessionKey);
                    let ageInDays = (currentDate - recordDate) / (1000 * 60 * 60 * 24);
                    if (ageInDays > retentionDays) {
                        let deleteRequest = cursor.delete();

                        deleteRequest.onsuccess = function() {
                            console.log('已刪除過期記錄', cursor.value.sessionKey);
                        };

                        deleteRequest.onerror = function(event) {
                            console.error('刪除記錄錯誤: ' + event.target.errorCode);
                        };
                    }
                    cursor.continue();
                }
            };

            objectStore.openCursor().onerror = function(event) {
                console.error('檢查過期記錄錯誤: ' + event.target.errorCode);
            };
        }

        // 顯示歷史記錄
        function displayHistory() {
            let historyList = document.getElementById('historyList');
            historyList.innerHTML = ''; // 清空現有的顯示
            let transaction = db.transaction(['Records'], 'readonly');
            let objectStore = transaction.objectStore('Records');

            objectStore.openCursor().onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    let sessionData = cursor.value;
                    sessionData.operations.forEach(operation => {
                        let listItem = document.createElement('li');
                        listItem.textContent = `Session: ${sessionData.sessionKey}, Round: ${operation.round}, Content: ${operation.content}, Timestamp: ${operation.timestamp}`;
                        historyList.appendChild(listItem);
                    });
                    cursor.continue();
                }
            };

            objectStore.openCursor().onerror = function(event) {
                console.error('顯示歷史記錄錯誤: ' + event.target.errorCode);
            };
        }
    </script>
</body>
</html>
