<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB 輸入範例</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.27/dist/vue.global.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>操作記錄範例</h1>
        <form @submit.prevent="addOperation">
            <label for="content">內容:</label>
            <input type="text" id="content" v-model="content" required>
            <br><br>
            <button type="submit">提交</button>
        </form>
        <button @click="exportDatabase">匯出所有操作記錄</button>
        <button @click="clearDatabase">清除所有操作記錄</button>
        <h2>歷史記錄</h2>
        <ul>
            <li v-for="operation in operations" :key="operation.id">
                Session: {{ operation.sessionKey }}, Round: {{ operation.round }}, Content: {{ operation.content }}, Timestamp: {{ operation.timestamp }}
            </li>
        </ul>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const db = ref(null);
                const operations = ref([]);
                const content = ref('');
                const sessionKey = ref(new Date().toISOString());
                const round = ref(1);
                const retentionDays = ref(7);

                const openDatabase = () => {
                    let request = indexedDB.open('OperationsDB', 1);

                    request.onupgradeneeded = function(event) {
                        db.value = event.target.result;
                        if (!db.value.objectStoreNames.contains('Records')) {
                            db.value.createObjectStore('Records', { keyPath: 'sessionKey' });
                        }
                    };

                    request.onsuccess = function(event) {
                        db.value = event.target.result;
                        console.log('資料庫開啟成功');
                        deleteOldRecords();
                        displayHistory();
                    };

                    request.onerror = function(event) {
                        console.error('資料庫錯誤: ' + event.target.errorCode);
                    };
                };

                const addOperation = () => {
                    let transaction = db.value.transaction(['Records'], 'readwrite');
                    let objectStore = transaction.objectStore('Records');
                    let getRequest = objectStore.get(sessionKey.value);

                    getRequest.onsuccess = function(event) {
                        let sessionData = event.target.result || { sessionKey: sessionKey.value, operations: [] };
                        let newOperation = {
                            round: round.value,
                            content: content.value,
                            timestamp: new Date().toISOString()
                        };
                        sessionData.operations.push(newOperation);
                        round.value++;
                        let putRequest = objectStore.put(sessionData);

                        putRequest.onsuccess = function(event) {
                            console.log('操作記錄新增成功');
                            displayHistory();
                        };

                        putRequest.onerror = function(event) {
                            console.error('新增操作記錄錯誤: ' + event.target.errorCode);
                        };
                    };

                    getRequest.onerror = function(event) {
                        console.error('獲取 session 資料錯誤: ' + event.target.errorCode);
                    };
                };

                const exportDatabase = () => {
                    let transaction = db.value.transaction(['Records'], 'readonly');
                    let objectStore = transaction.objectStore('Records');
                    let allRecords = [];

                    objectStore.openCursor().onsuccess = function(event) {
                        let cursor = event.target.result;
                        if (cursor) {
                            allRecords.push(cursor.value);
                            cursor.continue();
                        } else {
                            let dataStr = JSON.stringify(allRecords, null, 2);
                            let dataBlob = new Blob([dataStr], { type: 'application/json' });
                            let url = URL.createObjectURL(dataBlob);

                            let link = document.createElement('a');
                            link.href = url;
                            link.download = 'operations.json';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                            console.log('匯出完成');
                        }
                    };

                    objectStore.openCursor().onerror = function(event) {
                        console.error('匯出錯誤: ' + event.target.errorCode);
                    };
                };

                const clearDatabase = () => {
                    let transaction = db.value.transaction(['Records'], 'readwrite');
                    let objectStore = transaction.objectStore('Records');
                    let clearRequest = objectStore.clear();

                    clearRequest.onsuccess = function(event) {
                        console.log('所有操作記錄已清除');
                        displayHistory();
                    };

                    clearRequest.onerror = function(event) {
                        console.error('清除操作記錄錯誤: ' + event.target.errorCode);
                    };
                };

                const deleteOldRecords = () => {
                    let transaction = db.value.transaction(['Records'], 'readwrite');
                    let objectStore = transaction.objectStore('Records');
                    let currentDate = new Date();

                    objectStore.openCursor().onsuccess = function(event) {
                        let cursor = event.target.result;
                        if (cursor) {
                            let recordDate = new Date(cursor.value.sessionKey);
                            let ageInDays = (currentDate - recordDate) / (1000 * 60 * 60 * 24);
                            if (ageInDays > retentionDays.value) {
                                let deleteRequest = cursor.delete();

                                deleteRequest.onsuccess = function() {
                                    console.log('已刪除過期記錄', cursor.value.sessionKey);
                                };

                                deleteRequest.onerror = function(event) {
                                    console.error('刪除記錄錯誤: ' + event.target.errorCode);
                                };
                            }
                            cursor.continue();
                        }
                    };

                    objectStore.openCursor().onerror = function(event) {
                        console.error('檢查過期記錄錯誤: ' + event.target.errorCode);
                    };
                };

                const displayHistory = () => {
                    let transaction = db.value.transaction(['Records'], 'readonly');
                    let objectStore = transaction.objectStore('Records');
                    operations.value = [];

                    objectStore.openCursor().onsuccess = function(event) {
                        let cursor = event.target.result;
                        if (cursor) {
                            let sessionData = cursor.value;
                            sessionData.operations.forEach(operation => {
                                operations.value.push({
                                    id: `${sessionData.sessionKey}-${operation.round}`,
                                    sessionKey: sessionData.sessionKey,
                                    round: operation.round,
                                    content: operation.content,
                                    timestamp: operation.timestamp
                                });
                            });
                            cursor.continue();
                        }
                    };

                    objectStore.openCursor().onerror = function(event) {
                        console.error('顯示歷史記錄錯誤: ' + event.target.errorCode);
                    };
                };

                onMounted(openDatabase);

                return {
                    content,
                    operations,
                    addOperation,
                    exportDatabase,
                    clearDatabase
                };
            }
        }).mount('#app');
    </script>
</body>
</html>