<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin-top: 50px;
            font-family: Arial, sans-serif !important;
            color: #fff !important;
            /* 背景圖優化 - 確保在RWD情況下正確延伸 */
            background-image: url("images/background1.jpg") !important;
            background-size: cover;
            background-repeat: no-repeat; 
            background-position: center center;
            background-attachment: fixed; /* 固定背景，滾动時不移動 */
            min-height: 100vh; /* 確保背景至少與視窗一樣高 */
            width: 100%; /* 確保占滿整個視窗寬度 */
            overflow-x: hidden; /* 防止水平滾动条 */
        }

        .header {
            text-align: center;
            padding: 3px;
            background-color: #f2f2f2;
        }

        /* 優化容器在不同螢幕尺寸下的表現 */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 1fr;
            gap: 10px;
            height: 80vh;
            margin-top: 2%;
            max-width: 100%; /* 確保不超出螢幕 */
            padding: 0 15px; /* 增加側邊間距 */
        }

        /* 在小螢幕裝置上調整排版 */
        @media (max-width: 768px) {
            body {
                margin-top: 20px; /* 減少頂部間距 */
            }
            
            .container {
                height: auto; /* 高度自動調整 */
                gap: 5px; /* 減小間距 */
            }
        }

        /* 在超小螢幕裝置上進一步調整 */
        @media (max-width: 480px) {
            .container {
                grid-template-columns: 1fr 1fr; /* 減少網格列數 */
                padding: 0 10px; /* 減小側邊間距 */
            }
            
            /* 適應小螢幕的中央區域 */
            .center {
                grid-column: 1 / span 2 !important;
            }
        }

        .box {
            border: 2px dashed black;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* 為卡片的絕對定位提供參考 */
            min-height: 100px; /* 設置最小高度以便拖放 */
        }

        .center {
            border: 2px solid black;
            grid-column: 2 / span 2;
            grid-row: 2 / span 2;
            align-items:end;
            padding:5px;
            min-height:35vh;
        }

        .bottom {
            display: flex;
            flex-wrap: wrap; /* 允許內容換行 */
            border: 2px dashed rgb(134, 9, 3);
            grid-column: 1 / span 4;
            min-height: 150px; /* 最小高度 */
            position: relative;
            align-items: center;
            justify-content: center;
            padding: 10px; /* 內間距，確保內容不緊貼邊界 */
            gap: 10px; /* 卡片之間的間距 */
        }

        .card {
            position: absolute; /* 絕對定位 */
            cursor: grab;
            transition: transform 0.3s, width 0.3s, height 0.3s, z-index 0.3s;
            border: 2px solid #000;
            box-sizing: border-box;
            /*擺上卡背圖*/
            /*background-image: url("cardback.png");*/
            background-size: cover;
            background-repeat: no-repeat; 
            background-position: center;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
        }

        .card-front {
			/*background-image: url("cardface.png");*/
            background-size: cover;
            background-repeat: no-repeat; 
            background-position: center;
            /*background-color: #fff;*/
            background-blend-mode: multiply; /* 或 screen，根據你想要的效果 */
            background-color: rgba(128, 128, 128, 0.5); /* 半透明的灰色 */
            color: #fff;
            font-size: 15px;
        }

        .card-back {
            /*background-color: #333;*/
            color: white;
            transform: rotateY(180deg);
            font-size: 15px;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-number {
            position: absolute;
            top: 0;
            left: 0;
            color: #E0E0E0;
            font-size: 24px;
            font-weight: bold;
            margin: 4px;
        }

        /* 調整回合 區塊 */
        .round-display {
            grid-column: 1 / span 4;
            text-align: center;
            font-size: 24px;
            color: #fff;
        }

        .hidden-front {
            display: none;
        }

        .card.is-clicked {
            transform: translateY(-10px); /* 向上移動 10px */
            z-index: 10; /* 提升 z-index 以確保卡片在頂層 */
        }

        h1 {
            margin: 5px;
        }

        .forbidden-drop {
            cursor: not-allowed;
        }

        .center-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box; /* 確保 padding 和 border 不會影響元素的總大小 */
        }

        .textareaContent {
            font-size: 20px;
            padding: 5px;
            border: 2px solid #ccc;
            border-radius: 5px;
            resize: none;
            width: 100%;
            height: 100%; /* 調整高度以適應 RWD */
            box-sizing: border-box; /* 確保 padding 和 border 不會影響元素的總大小 */
        }

        .center .card {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .modal-title{
            color: #000; /* 設置文字顏色為黑色 */
        }

        .modal-body p {
            color: #000; /* 設置文字顏色為黑色 */
        }

        /* 用法說明的 寬度 */
        .modal-dialog {
            max-width: 80% !important; /* 設置模態框寬度為 80% */
        }

        /* 用於隱藏卡片 */
        .card[style*="opacity: 0"] {
            visibility: hidden;
        }

        .bottom_button_area {
            display: flex;
            flex-wrap: wrap; /* 允許內容換行 */
            grid-column: 1 / span 4;
            position: relative;
            align-items: center;
            justify-content: center;
            padding: 10px; /* 內間距，確保內容不緊貼邊界 */
            gap: 10px;
        }

    </style>
    <!--Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <title>小教室</title>
</head>
<body>
    <div id="app">
        <div class="container">
            <div v-for="box in zodiacBoxes" :key="box.id" class="box" @dragover.prevent="dragOver(box.id, $event)" @drop="dropCard(box.id, $event)" @click="boxClickSelectCard(box.id)">
                <span style="font-size: 2em;">{{ box.label }}</span>
                <div v-for="(card, index) in cardsInBox(box.id)" :key="card.id" class="card" :style="cardStyle(card, index, box.id)" draggable="false" @dragstart="dragCard(card, $event)" @click="flipCard(card)">
                    <div class="card-inner" :class="{ 'is-flipped': card.isFlipped }">
                        <div class="card-front" :style="cardBgStyle(card,'front')">
                            <h1>{{ card.frontText }}</h1>
                        </div>
                        <div class="card-back" :style="cardBgStyle(card,'back')">
                            <h1>{{ card.backText }}</h1>
                        </div>
                    </div>
                    <div class="card-number">{{ card.number }}</div>
                </div>
            </div>
            <div class="box center" @dragover.prevent="dragOver('center', $event)" @drop="dropCard('center', $event)"  @click="boxClickSelectCard('center')">
                <div class="center-text">
                    <div style="display: flex;margin: 5px;">
                        <!-- Left side buttons -->
                        <div style="display: flex;">
                            <!-- Button trigger modal : https://bootstrap5.hexschool.com/docs/5.0/components/buttons/ -->
                            <button type="button" class="btn btn-outline-danger" style="margin-right: 10px;" data-bs-toggle="modal" data-bs-target="#DirectionsModal" @click.stop>規則說明</button>
                            <button type="button" class="btn btn-outline-info" style="margin-right: 10px;" data-bs-toggle="modal" data-bs-target="#CardsModal" @click.stop>抽牌說明</button>
                            <button type="button" class="btn btn-outline-warning" style="margin-right: 10px;" data-bs-toggle="modal" data-bs-target="#AllLinkModalLabel" @click.stop>連結資訊</button>
                        </div>
                        <!-- Right side time block -->
                        <div style="margin-left: auto; font-weight: bold;">目前時間 : {{ currentTime }}</div>
                    </div>
                    <div style="display: flex; margin-bottom: 10px; width: 100%; max-width: 100%;" @click.stop>
                        <select class="form-select" style="width: 30%; margin-right: 10px;" v-model="gender">
                            <option value="" hidden>性別</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                        <input type="text" class="form-control" style="width: 40%; margin-right: 10px;" v-model="cus_name" placeholder="姓名">
                        <select id="selectSubject" ref="selectSubject" class="form-select" style="width: 30%;">
                            <option value="" hidden>主題</option>
                            <option value="工作">工作</option>
                            <option value="感情">感情</option>
                            <option value="財運">財運</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <textarea id="textareaContent" ref="textareaContent" name="textareaContent" class="textareaContent mt-1" required placeholder="問題描述，請詳述說明人、事、時。" @click.stop ></textarea>
                    <div style="display: flex;margin-top: 10px;">
                        <button type="button" v-if="!hasSelectedBox" class="btn btn-primary" style="margin-right: 10px;" @click="SubmitText()" @click.stop>確認</button>
                        <button type="button" v-if="!hasSelectedBox" class="btn btn-primary" style="margin-right: 10px;" @click="ModifySubmitText()" @click.stop>編輯</button>
                    </div>
                    <!-- Modal -->
                    <!-- 規則說明 -->
                    <div class="modal fade" id="DirectionsModal" tabindex="-1" aria-labelledby="DirectionsModalLabel" aria-hidden="true" @click.stop>
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="DirectionsModalLabel">規則說明</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @click.stop></button>
                            </div>
                            <div class="modal-body">
                                <P>1. 每一組牌只能問一個問題。如要問衍生問題，或其他問題，要再抽一組牌。</P>
                                <P>2. 問題務必「清楚精準」，最好設定明確時間。Ex:我XXX"三個月內"會不會有好桃花？我XXX"半年內"是否有升遷的可能？</P>
                                <P>3. 如果占問的事情有了結果，請不吝給予回饋（無論好壞，或是後續發展的回饋，讓我能隨時修正或是更加精進算牌技術。）</P>
                                <P>4. 健康、失物、賭博、代問，將不予回答。</P>
                                <P>5. 不清楚不明確的問題，也將不予回答。</P>
                                <P>6. 出國讀書和遊學打工，要先設定國家再問。</P>
                                <P>7. 提問之前，自己最好先有想法，結果會更為精確。</P>
                                <P>例如：</P>
                                <P>●我XXX想知道是否可以在十月底前賣掉房子？</P>
                                <P>●我XXX是否可以在三個月內和XXX發展感情？</P>
                                <P>●我XXX在七月有XXX的考試，想知道考運如何？</P>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @click.stop>Close</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    <!-- 抽牌說明 -->
					<div class="modal fade" id="CardsModal" tabindex="-1" aria-labelledby="CardsModal" aria-hidden="true" @click.stop>
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="CardsModal">抽牌說明</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @click.stop></button>
                            </div>
                            <div class="modal-body">
                                <P>1. 總共4副牌，共抽8張牌。</P>
                                <P>2. 第1輪共14張，抽2張，並選12宮位則一放。如1放酉，8放亥。</P>
                                <P>3. 卡片放置位置可以重覆。</P>
                                <P>4. 第2輪共14張，抽2張，並選12宮位則一放，與第1輪相同。如3放酉，12放申。</P>
								<P>5. 第3輪共32張，抽3張，並選12宮位則一放，放置位置可以重覆，與前二輪相同。</P>
								<P>6. 最後1輪‧，數字1-12擇1即可。</P>
								<P></P>
								<P></P>
								<P></P>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @click.stop>Close</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 連結資訊 -->
                    <div class="modal fade" id="AllLinkModalLabel" tabindex="-1" aria-labelledby="AllLinkModalLabel" aria-hidden="true" @click.stop>
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="AllLinkModalLabel">連結資訊</h5>
                            <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
							<div class="modal-body" style="text-align:center;">
								<div style="display: flex; justify-content: space-around;">
                                    <!-- 問卷區塊 -->
                                    <div style="text-align: center;">
                                        <p>問卷</p>
                                        <a href="https://forms.gle/LcBrCzUvLagm7R5Z8" target="_blank">
                                            <img src="images/feedbackQR.jpg" alt="問卷連結">
                                        </a>
                                    </div>
                                
                                    <!-- 好友＠0區塊 -->
                                    <div style="text-align: center;">
                                        <p>好友＠035huiof</p>
                                        <a href="https://lin.ee/seLphIC" target="_blank">
                                            <img src="images/@035huiof.png" alt="好友">
                                        </a>
                                    </div>
                                
                                    <!-- 社群區塊 -->
                                    <div style="text-align: center;">
                                        <p>社群</p>
                                        <a href="https://line.me/ti/g2/1DKrqd7y118-txklw0DKV0XkdIqBmLKTDIiu8A?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank">
                                            <img src="images/LINEgroup.jpg" alt="社群" border="0" height=339 width=336>
                                        </a>
                                    </div>
                                </div>
							</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                <div v-for="(card, index) in cardsInBox('center')" :key="card.id" class="card" :style="cardStyle(card, index, 'center')" draggable="false" @dragstart="dragCard(card, $event)" @click="flipCard(card)">
                    <div class="card-inner" :class="{ 'is-flipped': card.isFlipped }">
                        <div class="card-front" :style="cardBgStyle(card,'front')">
                            <h1>{{ card.frontText }}</h1>
                        </div>
                        <div class="card-back" :style="cardBgStyle(card,'back')">
                            <h1>{{ card.backText }}</h1>
                        </div>
                    </div>
                    <div class="card-number">{{ card.number }}</div>
                </div>
            </div>
            <div class="bottom" :style="{ minHeight: area_grid_heigh + 'px' }">
                <div v-for="(card, index) in cardsInBox('bottom')" :key="card.id" class="card" :style="bottomCardStyle(card, index)" :draggable="!isExtraDrawMode" @dragstart="dragCard(card, $event)" @click="clickCard(card)" :class="{ 'is-clicked': card.isClicked }">
                    <div class="card-inner" :class="{ 'is-flipped': card.isFlipped }">
                        <div class="card-front" :class="{ 'hidden-front': card.isDragging }" :style="cardBgStyle(card,'front')">
                            <h1>{{ card.frontText }}</h1>
                        </div>
                        <div class="card-back" :style="cardBgStyle(card,'back')">
                            <!--<h1>{{ card.backText }}</h1>-->
                        </div>
                    </div>
                    <div class="card-number" style="color:#730083;">{{card.number}}</div>
                </div>
            </div>
            <div class="round-display">
                {{ roundStatus }}
            </div>
            <div class="bottom_button_area" v-show="isExplorerNowVisible">
                <span><button type="button" class="btn btn-primary" style="margin-right: 10px;" @click="explorerNow()">匯出本次操作紀錄</button></span>
                <span><button type="button" class="btn btn-primary" style="margin-right: 10px;" @click="refreshPage()">再抽一次</button></span>
                <!-- 加抽按鈕常駐顯示 -->
                <span><button type="button" class="btn btn-success" style="margin-right: 10px;" @click="addExtraCards()">加抽</button></span>
            </div>
            <!-- 加抽模式下也顯示加抽按鈕與結束加抽 -->
            <div class="bottom_button_area" v-if="isExtraDrawMode">
                <span v-if="!isCardSetSelectionMode">
                    <button type="button" class="btn btn-success" style="margin-right: 10px;" @click="addExtraCards()">返回</button>
                </span>
                <span>
                    <button type="button" class="btn btn-danger" style="margin-right: 10px;" @click="endExtraDraw()">結束加抽</button>
                </span>
            </div>
        </div>
    </div>
    <script>
        /**
         * 紫微牌抽卡應用
         * 使用 Vue 3 Composition API 實現卡片拖放、翻轉和狀態管理功能
         */
        const { createApp, ref, onMounted, onUnmounted, watch, computed, nextTick, reactive } = Vue;

        createApp({
            setup() {
                // ===== 基本資料與狀態 =====
                const cards = ref([]);
                const cardIndex = ref(0);
                const currentRound = ref(0);
                const draggedCount = ref(0);
                const isClickedCount = ref(0);
                const dropIndex = ref(0);
                const roundStatus = ref("準備第一回合");
                const draggingCard = ref(null);
                const isExplorerNowVisible = ref(false);
                const area_grid_heigh = ref(150);
                const hasSelectedBox = ref(false);
                const isCardSetSelectionMode = ref(false); // 新增牌組選擇模式變數
                const extraDrawUsedCards = ref({}); // { 0: Set(), 1: Set(), ... }
                
                // 表單相關資料 - 使用 reactive 集中管理表單狀態可提高效能
                const formData = reactive({
                    subject: '',
                    content: '',
                    gender: '',
                    name: ''
                });
                
                // DOM 引用
                const selectSubject = ref(null);
                const textareaContent = ref(null);
                const gender = ref('');
                const cus_name = ref('');
                const currentTime = ref("");

                // ===== 資料庫相關 =====
                const db = ref(null);
                const operations = ref([]);
                const content = ref('');
                const sessionKey = ref('');
                const retentionDays = ref(7);

                // ===== 12宮位名稱定義 - 使用 reactive 優於直接物件 =====
                const locations = reactive({
                    '1': '巳',
                    '2': '午',
                    '3': '未',
                    '4': '申',
                    '5': '辰',
                    '6': '酉',
                    '7': '卯',
                    '8': '戌',
                    '9': '寅',
                    '10': '丑',
                    '11': '子',
                    '12': '亥',
                    'center': '中心區域'
                });

                // ===== 計算屬性 =====
                
                /**
                 * 12宮位盒子，排除中心區域
                 * 效能優化: 使用 computed 快取結果避免重複計算
                 */
                const zodiacBoxes = computed(() => Object.keys(locations)
                    .filter(key => key !== 'center')
                    .sort((a, b) => Number(a) - Number(b))
                    .map(key => ({ id: key, label: locations[key] }))
                );

                /**
                 * 獲取當前回合的資料
                 */
                const currentRoundData = computed(() => rounds[currentRound.value]);
                
                /**
                 * 計算當前可選卡片數量 - 新增計算屬性優化邏輯
                 */
                const remainingCardCount = computed(() => {
                    if (currentRound.value >= rounds.length) return 0;
                    return rounds[currentRound.value].drawCount - draggedCount.value;
                });

                // ===== 回合定義 =====
                // 使用 reactive 可提升 rounds 的存取效率
                const rounds = reactive([
                    { area_grid_heigh:"150", card_back_background_image:"images/back3.jpg", card_face_background_image:"images/face10.jpg", totalCards: 14, drawCount: 2, texts: [
                                                            { "front": "紫微", "back": "主星" }, 
                                                            { "front": "天機", "back": "主星" }, 
                                                            { "front": "太陽", "back": "主星" }, 
                                                            { "front": "武曲", "back": "主星" },
                                                            { "front": "天同", "back": "主星" }, 
                                                            { "front": "廉貞", "back": "主星" }, 
                                                            { "front": "天府", "back": "主星" }, 
                                                            { "front": "太陰", "back": "主星" },
                                                            { "front": "貪狼", "back": "主星" }, 
                                                            { "front": "巨門", "back": "主星" }, 
                                                            { "front": "天相", "back": "主星" }, 
                                                            { "front": "天梁", "back": "主星" },
                                                            { "front": "七殺", "back": "主星" }, 
                                                            { "front": "破軍", "back": "主星" }
                                                            ]},
                    { area_grid_heigh:"150", card_back_background_image:"images/back2.jpg", card_face_background_image:"images/face16.jpg", totalCards: 14, drawCount: 2, texts: [
                                                            { "front": "文昌", "back": "副星" }, 
                                                            { "front": "文曲", "back": "副星" }, 
                                                            { "front": "左輔", "back": "副星" }, 
                                                            { "front": "右弼", "back": "副星" },
                                                            { "front": "天魁", "back": "副星" }, 
                                                            { "front": "天鉞", "back": "副星" }, 
                                                            { "front": "地空", "back": "副星" }, 
                                                            { "front": "地劫", "back": "副星" },
                                                            { "front": "火星", "back": "副星" }, 
                                                            { "front": "鈴星", "back": "副星" }, 
                                                            { "front": "擎羊", "back": "副星" }, 
                                                            { "front": "陀羅", "back": "副星" },
                                                            { "front": "天馬", "back": "副星" }, 
                                                            { "front": "祿存", "back": "副星" }
                                                        ]},
                    { area_grid_heigh:"250", card_back_background_image:"images/back1.jpg", card_face_background_image:"images/face17.jpg", totalCards: 32, drawCount: 3, texts: [
                                                            { "front": "天官", "back": "乙級星" },
                                                            { "front": "天福", "back": "乙級星" },
                                                            { "front": "天廚", "back": "乙級星" },
                                                            { "front": "天刑", "back": "乙級星" },
                                                            { "front": "天姚", "back": "乙級星" },
                                                            { "front": "解神", "back": "乙級星" },
                                                            { "front": "天巫", "back": "乙級星" },
                                                            { "front": "天月", "back": "乙級星" },
                                                            { "front": "陰煞", "back": "乙級星" },
                                                            { "front": "台輔", "back": "乙級星" },
                                                            { "front": "封誥", "back": "乙級星" },
                                                            { "front": "天空", "back": "乙級星" },
                                                            { "front": "天哭", "back": "乙級星" },
                                                            { "front": "天虛", "back": "乙級星" },
                                                            { "front": "龍池", "back": "乙級星" },
                                                            { "front": "鳳閣", "back": "乙級星" },
                                                            { "front": "紅鸞", "back": "乙級星" },
                                                            { "front": "天喜", "back": "乙級星" },
                                                            { "front": "孤辰", "back": "乙級星" },
                                                            { "front": "寡宿", "back": "乙級星" },
                                                            { "front": "蜚廉", "back": "乙級星" },
                                                            { "front": "破碎", "back": "乙級星" },
                                                            { "front": "華蓋", "back": "乙級星" },
                                                            { "front": "咸池", "back": "乙級星" },
                                                            { "front": "天德", "back": "乙級星" },
                                                            { "front": "月德", "back": "乙級星" },
                                                            { "front": "天才", "back": "乙級星" },
                                                            { "front": "天壽", "back": "乙級星" },
                                                            { "front": "三台", "back": "乙級星" },
                                                            { "front": "八座", "back": "乙級星" },
                                                            { "front": "恩光", "back": "乙級星" },
                                                            { "front": "天貴", "back": "乙級星" }
                                                            ]},
                    { area_grid_heigh:"150", card_back_background_image:"images/back4.jpg", card_face_background_image:"images/face9.jpg", totalCards: 12, drawCount: 1, texts: [
                                                            { "front": "長生", "back": "宮位" }, 
                                                            { "front": "沐浴", "back": "宮位" }, 
                                                            { "front": "冠帶", "back": "宮位" }, 
                                                            { "front": "臨官", "back": "宮位" },
                                                            { "front": "帝旺", "back": "宮位" }, 
                                                            { "front": "衰", "back": "宮位" }, 
                                                            { "front": "病", "back": "宮位" }, 
                                                            { "front": "死", "back": "宮位" },
                                                            { "front": "墓", "back": "宮位" }, 
                                                            { "front": "絕", "back": "宮位" }, 
                                                            { "front": "胎", "back": "宮位" }, 
                                                            { "front": "養", "back": "宮位" }
                                                            ]}
                ]);

                // ===== 方法定義 =====

                /**
                 * 初始化當前回合
                 * 效能優化: 批量處理卡片生成，減少 DOM 重繪次數
                 */
                const initRound = () => {
                    if (currentRound.value < rounds.length) {
                        let round = currentRoundData.value;
                        // 批量處理, 先過濾再一次性設置新值
                        const remainingCards = cards.value.filter(card => card.location !== 'bottom');
                        
                        // 洗牌操作
                        const shuffledTexts = shuffleArray([...round.texts]);
                        
                        // 預先創建所有新卡片
                        const newCards = Array.from({ length: round.totalCards }, (_, i) => ({
                            id: cardIndex.value + i + 1,
                            number: i + 1,
                            isFlipped: true,
                            location: 'bottom',
                            frontText: shuffledTexts[i].front,
                            backText: shuffledTexts[i].back,
                            touchX: null,
                            touchY: null,
                            isDragging: false,
                            isClicked: false,
                            zIndex: 0,
                            card_back_background_image: round.card_back_background_image,
                            card_face_background_image: round.card_face_background_image
                        }));
                        
                        // 更新卡片索引
                        cardIndex.value += round.totalCards;
                        
                        // 一次性設置新卡片列表 (減少響應式更新次數)
                        cards.value = [...remainingCards, ...newCards];

                        // 更新回合狀態
                        roundStatus.value = (currentRound.value + 1) !== rounds.length
                            ? `第 ${currentRound.value + 1} 副牌：請選擇 ${round.drawCount} 張牌到12宮位任一區塊（可重疊）`
                            : `第 ${currentRound.value + 1} 副牌：請選擇 ${round.drawCount} 張牌挪至中間位子`;

                        // 重設計數器和區域高度
                        draggedCount.value = 0;
                        area_grid_heigh.value = round.area_grid_heigh;
                    }
                };

                /**
                 * 洗牌算法優化 - 使用效能更好的 Fisher-Yates 算法
                 */
                const shuffleArray = (array) => {
                    const result = [...array];
                    for (let i = result.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [result[i], result[j]] = [result[j], result[i]];
                    }
                    return result;
                };

                /**
                 * 獲取指定位置的卡片，並依序號排序
                 * 效能優化: 記憶化處理，減少重複計算
                 */
                const boxCardsCache = reactive({});
                const cardsInBox = (box) => {
                    if (!cards.value) return [];
                    // 檢查緩存是否有效
                    const cacheKey = `${box}-${cards.value.map(c => c.id + c.location).join(',')}`;
                    if (boxCardsCache[cacheKey]) {
                        return boxCardsCache[cacheKey];
                    }
                    
                    // 計算新結果
                    const result = cards.value
                        .filter(card => card.location === box)
                        .sort((a, b) => a.number - b.number);
                    
                    // 緩存結果
                    boxCardsCache[cacheKey] = result;
                    return result;
                };

                // 函數簡化
                const flipCard = (card) => {
                    // 保留為空函數
                };

                /**
                 * 使用點擊區塊方式選取卡牌
                 * 效能優化: 使用變量快取複雜表達式結果
                 */
                const boxClickSelectCard = (box) => {
                    if (isExplorerNowVisible.value) return;

                    const textareaElem = textareaContent.value;
                    if (!textareaElem || textareaElem.value === "" || !textareaElem.readOnly) {
                        Swal.fire({
                            icon: 'warning',
                            title: '請填寫問題內容後確定',
                            text: '確定完畢後抽牌'
                        });
                        return;
                    }

                    const round = currentRoundData.value;
                    Swal.fire({
                        title: `目前所在的宮位為「${locations[box]}」`,
                        html: `[${roundStatus.value}]<br><br>請輸入卡片號碼(1~${round.totalCards})`,
                        input: 'text',
                        inputAttributes: {
                            autocapitalize: 'off'
                        },
                        showCancelButton: true,
                        confirmButtonText: '確定',
                        cancelButtonText: '取消',
                        showLoaderOnConfirm: true,
                        preConfirm: (cardNumber) => {
                            return cardNumber;
                        }
                    }).then((result) => {
                        if (result.isConfirmed && result.value !== null) {
                            const parsedNumber = parseInt(result.value);
                            if (isNaN(parsedNumber)) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '請輸入有效的數字'
                                });
                                return;
                            }
                            const card = cards.value.find(c =>
                                c.number === parsedNumber &&
                                c.location === 'bottom' &&
                                c.frontText !== ''
                            );
                            if (card) {
                                draggingCard.value = card;
                                dropCard(box);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '找不到該卡片號碼'
                                });
                            }
                        }
                    });
                };

                /**
                 * 處理卡片拖曳開始事件
                 * 修正: 添加事件參數
                 */
                const dragCard = (card, e) => {
                    if (isExtraDrawMode.value) return;

                    const event = e || window.event;
                    if (!event) return;

                    if(!card.isClicked) {
                        if(card.location === 'bottom'){
                            Swal.fire({
                                icon: 'info',
                                title: '請先選取卡片,再拖曳'
                            });
                        }
                        return;
                    }

                    card.isDragging = true;

                    if (card.location === 'bottom' &&
                        card.isClicked &&
                        remainingCardCount.value > 0) {
                        event.dataTransfer.dropEffect = 'move';
                        event.dataTransfer.setData('text/plain', card.id.toString());
                    }
                };

                /**
                 * 處理卡片放置事件
                 * 修正: 添加事件參數並處理事件不存在的情況
                 */
                const dropCard = (box, e) => {
                    if (isExtraDrawMode.value) return;

                    const event = e || window.event;

                    if (box === 'bottom') {
                        Swal.fire({
                            icon: 'error',
                            title: '不可將卡片丟到 bottom 區域'
                        });
                        return;
                    }

                    let card;
                    if (event && event.type === 'drop') {
                        const cardId = parseInt(event.dataTransfer.getData('text/plain'));
                        card = cards.value.find(card => card.id === cardId);
                    } else {
                        card = draggingCard.value;
                    }

                    // 如果沒有有效卡片或已達到數量限制，退出
                    if (!card || 
                        card.location !== 'bottom' || 
                        draggedCount.value >= (isExtraDrawMode.value ? extraDrawCount.value : currentRoundData.value.drawCount)) {
                        return;
                    }

                    // 檢查回合放置規則
                    // --- 加抽模式下只允許放 center ---
                    if (isExtraDrawMode.value) {
                        if (box !== 'center') {
                            Swal.fire({
                                icon: 'warning',
                                title: '加抽模式下只能將牌放到中心區塊'
                            });
                            return;
                        }
                    } else {
                        const isLastRound = currentRound.value === rounds.length - 1;
                        if (isLastRound && box !== 'center') {
                            Swal.fire({
                                icon: 'warning',
                                title: '最後一回合的卡片只能放在 center 區域'
                            });
                            return;
                        } else if (!isLastRound && box === 'center') {
                            Swal.fire({
                                icon: 'warning',
                                title: '只有最後一回合才能將卡片丟到 center 區域'
                            });
                            return;
                        }
                    }

                    nextTick(() => {
                        try {
                            // 創建佔位卡片
                            const placeholderId = ++cardIndex.value;
                            const placeholderCard = {
                                id: placeholderId,
                                number: card.number,
                                isFlipped: true,
                                location: 'bottom',
                                frontText: '',
                                backText: '',
                                isDragging: false,
                                isClicked: false,
                                zIndex: -1,
                                opacity: 0,
                                card_back_background_image: card.card_back_background_image,
                                card_face_background_image: card.card_face_background_image
                            };
                            
                            // 更新原卡片屬性
                            card.location = box;
                            card.isFlipped = false;
                            card.isDragging = false;
                            card.isClicked = false;
                            card.number = ++dropIndex.value;
                            
                            // 添加新卡片到卡片集合
                            cards.value.push(placeholderCard);
                            
                            // 更新計數器
                            draggedCount.value++;
                            isClickedCount.value = 0;
                            
                            // 判斷是否為加抽模式
                            if (isExtraDrawMode.value) {
                                // 達到加抽數量即結束
                                if (draggedCount.value === extraDrawCount.value) {
                                    isExtraDrawMode.value = false;
                                    // 標記加抽已結束
                                    // 不重設 extraDrawRoundIndex，讓 dragOver/dropCard 禁止拖曳
                                    isExplorerNowVisible.value = true;
                                    roundStatus.value = "加抽完成！";
                                    ExtraWriteLog();
                                }
                            } else {
                                // 一般流程
                                if (draggedCount.value === currentRoundData.value.drawCount) {
                                    processRoundCompletion();
                                }
                            }

                            // 清除卡片緩存
                            if (boxCardsCache) {
                                Object.keys(boxCardsCache).forEach(key => delete boxCardsCache[key]);
                            }
                        } catch (error) {
                            console.error('放置卡片時發生錯誤:', error);
                        }
                    });
                };

                /**
                 * 處理回合完成 - 新增輔助函數優化代碼結構
                 */
                const processRoundCompletion = () => {
                    if (currentRound.value + 1 < rounds.length) {
                        // 進入下一回合
                        currentRound.value++;
                        initRound();
                    } else {
                        // 完成所有回合
                        finishDivination();
                    }
                };
                
                /**
                 * 完成抽牌 - 新增輔助函數優化代碼結構
                 */
                const finishDivination = () => {
                    isExplorerNowVisible.value = true;
                    roundStatus.value = "抽排完畢囉~請耐心等候30~40分!";
                    
                    // 使用 setTimeout 避免 UI 阻塞
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'info',
                            title: '請耐心等候30~40分!'
                        });
                        // 準備匯出數據
                        const responseJson = prepareExportData();
                        addOperation(responseJson);
                    }, 100);
                };
                
                /**
                 * 準備匯出數據 - 新增輔助函數優化代碼結構
                 */
                const prepareExportData = () => {
                    return cards.value
                        .filter(item => item.isFlipped === false)
                        .map(item => ({
                            "number": item.number,
                            "location": item.location,
                            "location_name": locations[item.location],
                            "frontText": item.frontText,
                            "backText": item.backText,
                        }))
                        .sort((a, b) => a.number - b.number);
                };

                /**
                 * 卡片樣式生成函數 - 使用 computed 代替直接計算
                 */
                // 計算基礎卡片尺寸
                const baseCardDimensions = computed(() => {
                    const aspectRatio = 2 / 3;
                    const boxHeight = 100;
                    const cardHeight = boxHeight - 4;
                    const cardWidth = cardHeight * aspectRatio;
                    
                    return {
                        width: cardWidth,
                        height: cardHeight
                    };
                });
                
                const cardStyle = (card, index, box) => {
                    const { width, height } = baseCardDimensions.value;
                    const offset = box === 'bottom' ? index * (width + 10) : index * 10;

                    // 基礎樣式
                    const style = {
                        position: 'relative',
                        margin: '0 5px',
                        width: `${width}px`,
                        height: `${height}px`,
                        zIndex: card.zIndex || 0
                    };

                    // 中間區塊牌組靠左排列，左至右
                    if (box === 'center') {
                        style.position = 'absolute';
                        style.left = `${index * (width + 10)}px`;
                        style.bottom = '0';
                        style.transform = 'none';
                    }
                    if (card.isDragging) {
                        style.position = 'absolute';
                        style.left = `${card.touchX}px`;
                        style.top = `${card.touchY}px`;
                    }

                    return style;
                };

                const bottomCardStyle = (card, index) => {
                    const { width, height } = baseCardDimensions.value;

                    return {
                        position: 'relative',
                        margin: '0 3px',
                        width: `${width}px`,
                        height: `${height}px`,
                        zIndex: card.zIndex || 0,
                        //transform: card.isClicked ? 'translateY(-10px)' : 'translateY(0)',
                        opacity: card.opacity
                    };
                };

                /**
                 * 背景樣式生成 - 使用緩存優化頻繁調用的函數
                 */
                const bgStyleCache = {};
                const cardBgStyle = (card, side) => {
                    // 生成緩存鍵
                    const cacheKey = `${side}-${side === "front" ? card.card_face_background_image : card.card_back_background_image}`;
                    
                    // 檢查緩存
                    if (bgStyleCache[cacheKey]) {
                        return bgStyleCache[cacheKey];
                    }
                    
                    // 生成並緩存樣式
                    const style = {
                        backgroundImage: `url(${side === "front" ? card.card_face_background_image : card.card_back_background_image})`,
                        backgroundSize: 'cover',
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat'
                    };
                    
                    bgStyleCache[cacheKey] = style;
                    return style;
                };

                /**
                 * 點擊卡片事件處理
                 * 效能優化: 簡化邏輯分支
                 */
                const clickCard = (card) => {
                    // 牌組選擇模式
                    if (isCardSetSelectionMode.value && card.hasOwnProperty('roundIndex')) {
                        handleCardSetSelection(card);
                        return;
                    }

                    if (isExtraDrawMode.value && card.location === 'bottom') {
                        Swal.fire({
                            title: `確定要選擇 ${card.number} 號牌？`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: '確定',
                            cancelButtonText: '取消'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                card.isDragging = true;
                                // 找到原本卡片在 cards.value 的 index
                                const cardIdx = cards.value.findIndex(c => c.id === card.id);
                                setTimeout(() => {

                                    //const placeholderId = ++cardIndex.value;
                                    const placeholderCard = {
                                        id: card.number,
                                        number: card.number,
                                        isFlipped: true,
                                        location: 'bottom',
                                        frontText: '',
                                        backText: '',
                                        isDragging: false,
                                        isClicked: false,
                                        zIndex: -1,
                                        opacity: 0,
                                        card_back_background_image: card.card_back_background_image,
                                        card_face_background_image: card.card_face_background_image
                                    };

                                    cards.value.push(placeholderCard);

                                    card.location = 'center';
                                    card.isFlipped = false;
                                    card.isClicked = false;
                                    card.number = ++dropIndex.value;
                                    card.isDragging = false;
                                    draggedCount.value++;
                                    

                                    if (draggedCount.value === extraDrawCount.value) {
                                        isExtraDrawMode.value = false;
                                        isExplorerNowVisible.value = true;
                                        roundStatus.value = "加抽完成！";
                                        ExtraWriteLog();
                                    }
                                }, 200);
                            }
                        });

                        return;
                    }

                    // 已選擇狀態的處理
                    if(isClickedCount.value !== 0) {
                        // 只處理點擊已選卡片的情況
                        if(card.isClicked) {
                            isClickedCount.value = 0;
                            card.isClicked = false;
                        }
                        return;
                    } 
                    
                    // 選擇新卡片
                    isClickedCount.value = 1;
                    card.isClicked = true;
                };

                /**
                 * 拖曳經過事件處理
                 * 修正: 添加事件參數
                 */
                const dragOver = (box, e) => {
                    if (isExtraDrawMode.value) return;

                    // 防止未定義事件
                    const event = e || window.event;
                    if (!event) return;

                    // 防止默認行為以允許放置
                    event.preventDefault();

                    // 加抽結束後禁止拖曳，直到再次加抽
                    if (!isExtraDrawMode.value && extraDrawRoundIndex.value !== null && !isCardSetSelectionMode.value) {
                        event.dataTransfer.dropEffect = 'none';
                        if (event.target && event.target.classList) {
                            event.target.classList.add('forbidden-drop');
                        }
                        return;
                    }

                    // 加抽模式下，只允許 center 可拖曳，其餘禁止
                    let isForbidden;
                    if (isExtraDrawMode.value) {
                        isForbidden = box !== 'center';
                    } else {
                        isForbidden = box === 'bottom' ||
                            (currentRound.value === rounds.length - 1 && box !== 'center') ||
                            (currentRound.value !== rounds.length - 1 && box === 'center');
                    }

                    event.dataTransfer.dropEffect = isForbidden ? 'none' : 'move';

                    // 使用 classList 的 toggle 方法簡化代碼
                    if (event.target && event.target.classList) {
                        event.target.classList.toggle('forbidden-drop', isForbidden);
                    }
                };

                /**
                 * 表單確認與修改函數
                 * 效能優化: 批量處理樣式變更
                 */
                const SubmitText = () => {
                    const textarea = textareaContent.value;
                    const select = selectSubject.value;

                    if(!textarea || textarea.value === "") {
                        Swal.fire({
                            icon: 'warning',
                            title: '請填寫問題描述'
                        });
                        return;
                    }
                    
                    // 批量應用樣式變更
                    const readonlyStyles = {
                        readOnly: true,
                        disabled: true,
                        backgroundColor: "#E0E0E0"
                    };
                    
                    Object.entries(readonlyStyles).forEach(([key, value]) => {
                        if (key === 'backgroundColor') {
                            textarea.style[key] = value;
                            if (select) select.style[key] = value;
                        } else {
                            textarea[key] = value;
                            if (select) select[key] = value;
                        }
                    });
                };

                const ModifySubmitText = () => {
                    const textarea = textareaContent.value;
                    const select = selectSubject.value;
                    
                    if (!textarea || !select) return;
                    
                    // 批量應用樣式變更
                    textarea.readOnly = false;
                    textarea.style.backgroundColor = "#FFFFFF";
                    
                    select.disabled = false;
                    select.style.backgroundColor = "#FFFFFF";
                };

                /**
                 * 匯出資料庫記錄為 JSON 檔案
                 * @param {string} key - 會話金鑰，如果提供則只匯出該金鑰的記錄
                 */
                const exportDatabase = (key) => {
                    if (!db.value) {
                        console.error('資料庫未初始化');
                        return Promise.reject('資料庫未初始化');
                    }

                    return new Promise((resolve, reject) => {
                        const transaction = db.value.transaction(['Records'], 'readonly');
                        const objectStore = transaction.objectStore('Records');
                        const allRecords = [];

                        const cursorRequest = objectStore.openCursor();
                        
                        cursorRequest.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                // 根據 key 參數決定匯出範圍
                                if(key && key !== "") {
                                    if(cursor.value.sessionKey === key) {
                                        allRecords.push(cursor.value);
                                    }
                                } else {
                                    allRecords.push(cursor.value);
                                }
                                cursor.continue();
                            } else {
                                // 生成 JSON 文件並觸發下載
                                const dataStr = JSON.stringify(allRecords, null, 2);
                                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                                const url = URL.createObjectURL(dataBlob);

                                // 設定檔案名稱
                                const fileName = key ? 
                                    `${key}_${selectSubject.value.value}_${gender.value}_${cus_name.value}.json` :
                                    `all_records_${new Date().toISOString().slice(0, 10)}.json`;
                                
                                // 創建下載連結
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = fileName;
                                document.body.appendChild(link);
                                link.click();
                                
                                // 清理
                                setTimeout(() => {
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(url);
                                }, 100);
                                
                                resolve(allRecords);
                            }
                        };

                        cursorRequest.onerror = (event) => {
                            console.error('匯出錯誤:', event.target.errorCode);
                            reject(event.target.errorCode);
                        };
                    });
                };

                /**
                 * 清除資料庫中所有記錄
                 */
                const clearDatabase = () => {
                    if (!db.value) {
                        console.error('資料庫未初始化');
                        return Promise.reject('資料庫未初始化');
                    }

                    return new Promise((resolve, reject) => {
                        const transaction = db.value.transaction(['Records'], 'readwrite');
                        const objectStore = transaction.objectStore('Records');
                        const clearRequest = objectStore.clear();

                        clearRequest.onsuccess = () => resolve();
                        clearRequest.onerror = (event) => {
                            console.error('清除操作記錄錯誤:', event.target.errorCode);
                            reject(event.target.errorCode);
                        };
                    });
                };

                /**
                 * 刪除超過保留期限的舊記錄
                 */
                const deleteOldRecords = () => {
                    if (!db.value) {
                        console.error('資料庫未初始化');
                        return Promise.reject('資料庫未初始化');
                    }

                    return new Promise((resolve, reject) => {
                        const transaction = db.value.transaction(['Records'], 'readwrite');
                        const objectStore = transaction.objectStore('Records');
                        const currentDate = new Date();
                        let deletedCount = 0;

                        const cursorRequest = objectStore.openCursor();
                        
                        cursorRequest.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                // 計算記錄的年齡
                                const recordDate = new Date(cursor.value.operations[0].timestamp);
                                const ageInDays = (currentDate - recordDate) / (1000 * 60 * 60 * 24);
                                
                                // 超過保留期則刪除
                                if (ageInDays > retentionDays.value) {
                                    const deleteRequest = cursor.delete();
                                    deleteRequest.onsuccess = () => deletedCount++;
                                }
                                cursor.continue();
                            } else {
                                resolve(deletedCount);
                            }
                        };

                        cursorRequest.onerror = (event) => {
                            console.error('檢查過期記錄錯誤:', event.target.errorCode);
                            reject(event.target.errorCode);
                        };
                    });
                };

                /**
                 * 匯出和重載函數簡化
                 */
                const explorerNow = () => exportDatabase(sessionKey.value);
                const refreshPage = () => location.reload();

                // ===== 資料庫操作相關函數 =====
                
                /**
                 * 開啟 IndexedDB 資料庫連線
                 * 效能優化: 使用 Promise 封裝異步操作
                 */
                const openDatabase = () => {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('OperationsDB', 1);

                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('Records')) {
                                db.createObjectStore('Records', { keyPath: 'sessionKey' });
                            }
                        };

                        request.onsuccess = (event) => {
                            db.value = event.target.result;
                            resolve(db.value);
                        };

                        request.onerror = (event) => {
                            console.error('資料庫錯誤:', event.target.errorCode);
                            reject(event.target.errorCode);
                        };
                    });
                };

                /**
                 * 生成會話金鑰 - 使用 Promise 優化非同步流程
                 */
                const generateSessionKey = () => {
                    return new Promise((resolve, reject) => {
                        if (!db.value) {
                            reject('資料庫未初始化');
                            return;
                        }

                        const transaction = db.value.transaction(['Records'], 'readonly');
                        const objectStore = transaction.objectStore('Records');
                        
                        // 生成日期前綴
                        const today = new Date();
                        const prefix = today.toISOString().slice(0, 10).replace(/-/g, '');
                        let maxIndex = 0;

                        // 建立遊標請求
                        const cursorRequest = objectStore.openCursor();
                        
                        cursorRequest.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                const key = cursor.key;
                                if (key.startsWith(prefix)) {
                                    const index = parseInt(key.slice(-4));
                                    maxIndex = Math.max(maxIndex, index);
                                }
                                cursor.continue();
                            } else {
                                // 生成新金鑰
                                const newIndex = (maxIndex + 1).toString().padStart(4, '0');
                                const newKey = `${prefix}${newIndex}`;
                                sessionKey.value = newKey;
                                resolve(newKey);
                            }
                        };

                        cursorRequest.onerror = (event) => {
                            console.error('生成 session key 錯誤:', event.target.errorCode);
                            reject(event.target.errorCode);
                        };
                    });
                };

                /**
                 * 添加操作記錄 - 使用 Promise 簡化回調結構
                 */
                const addOperation = (data) => {
                    return new Promise((resolve, reject) => {
                        if (!db.value) {
                            reject('資料庫未初始化');
                            return;
                        }

                        const transaction = db.value.transaction(['Records'], 'readwrite');
                        const objectStore = transaction.objectStore('Records');
                        const getRequest = objectStore.get(sessionKey.value);

                        getRequest.onsuccess = (event) => {
                            // 合併現有數據或創建新數據
                            const sessionData = event.target.result || { 
                                sessionKey: sessionKey.value, 
                                content: textareaContent.value.value,
                                subject: selectSubject.value.value,
                                gender: gender.value,
                                cus_name: cus_name.value,
                                divination_time: currentTime.value,
                                operations: [] 
                            };

                            // 添加新操作
                            sessionData.operations.push({
                                cards: data,
                                timestamp: new Date().toISOString()
                            });

                            // 存入資料庫
                            const putRequest = objectStore.put(sessionData);
                            
                            putRequest.onsuccess = () => resolve(sessionData);
                            putRequest.onerror = (e) => reject('保存操作記錄失敗: ' + e.target.errorCode);
                        };

                        getRequest.onerror = (event) => {
                            reject('獲取 session 資料錯誤: ' + event.target.errorCode);
                        };
                    });
                };

                // 其他資料庫操作函數保持不變
                // ...existing code...

                /**
                 * 更新當前時間顯示 - 使用 Intl.DateTimeFormat 提高效能
                 */
                const timeFormatter = new Intl.DateTimeFormat('zh-tw', {
                    timeZone: 'Asia/Taipei',
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const updateTime = () => {
                    currentTime.value = timeFormatter.format(new Date());
                };

                // ===== 生命週期鉤子 =====
                onMounted(() => {
                    try {
                        // 使用 Promise 鏈處理初始化邏輯
                        openDatabase()
                            .then(() => generateSessionKey())
                            .then(() => {
                                // 初始化回合
                                initRound();
                                
                                // 設定時間更新
                                updateTime();
                                const intervalId = setInterval(updateTime, 1000);
                                
                                // 組件卸載時清除定時器
                                onUnmounted(() => {
                                    if (intervalId) {
                                        clearInterval(intervalId);
                                    }
                                });
                            })
                            .catch(err => {
                                console.error('初始化失敗:', err);
                                // 初始化失敗時顯示友好錯誤
                                alert('初始化失敗，請重新載入頁面');
                            });
                    } catch (error) {
                        console.error('生命週期鉤子發生錯誤:', error);
                    }
                });

                // ===== 監聽器 =====
                // 優化深層監聽為細粒度監聽
                watch(
                    () => cards.value.map(card => card.location),
                    (newLocations) => {
                        hasSelectedBox.value = newLocations.some(
                            location => location !== 'bottom' && location !== ''
                        );
                    },
                    { immediate: true }
                );

                /**
                 * 加抽功能 - 清空底部區域，顯示牌組選擇界面
                 */
                const addExtraCards = () => {
                    Swal.fire({
                        title: '確定要進行額外加抽嗎？',
                        text: '這將會清空底部區域並顯示牌組。',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '確定',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (!result.isConfirmed) {
                            return;
                        }
                        // 移除底部區域的所有卡片
                        cards.value = cards.value.filter(card => card.location !== 'bottom');
                        // 復預設高度
                        area_grid_heigh.value = 150;
                        // 進入牌組選擇模式
                        isCardSetSelectionMode.value = true;
                        isExtraDrawMode.value = true;
                        
                        // 為每個回合創建一張代表卡片
                        const cardSetCards = rounds.map((round, index) => ({
                            id: `cardset-${index}`,
                            number: index + 1,
                            isFlipped: true,  // 顯示牌背
                            location: 'bottom',
                            frontText: `第 ${index + 1} 副`,
                            backText: `第 ${index + 1} 副`,
                            isDragging: false,
                            isClicked: false,
                            zIndex: 0,
                            roundIndex: index, // 存儲回合索引以便選擇
                            card_back_background_image: round.card_back_background_image,
                            card_face_background_image: round.card_face_background_image
                        }));
                        
                        // 添加牌組選擇卡片到卡片集合
                        cards.value.push(...cardSetCards);
                        
                        // 更新回合狀態提示
                        roundStatus.value = "加抽模式：請點擊選擇要使用的牌組";
                        
                        // 確保加抽界面可見
                        isExplorerNowVisible.value = false;
                        
                        // 清除卡片緩存
                        if (boxCardsCache) {
                            Object.keys(boxCardsCache).forEach(key => delete boxCardsCache[key]);
                        }
                    });
                };

                // 新增：加抽模式旗標、回合索引與可抽取數量
                const isExtraDrawMode = ref(false);
                const extraDrawRoundIndex = ref(null);
                const extraDrawCount = ref(1); // 預設加抽1張，可動態調整

                /**
                 * 處理牌組選擇
                 * @param {Object} card - 被點擊的牌組代表卡片
                 */
                const handleCardSetSelection = (card) => {
                    if (!isCardSetSelectionMode.value || !card.hasOwnProperty('roundIndex')) {
                        return;
                    }

                    // 取得選中的副牌索引
                    const selectedRoundIndex = card.roundIndex;
                    const round = rounds[selectedRoundIndex];

                    // 初始化該副牌的加抽紀錄
                    if (!extraDrawUsedCards.value[selectedRoundIndex]) {
                        extraDrawUsedCards.value[selectedRoundIndex] = new Set();
                    }

                    const usedInExtra = extraDrawUsedCards.value[selectedRoundIndex];
                    const availableTexts = round.texts.filter(
                        t => !usedInExtra.has(`${t.front}|${t.back}`)
                    );

                    // 清空底部區域
                    cards.value = cards.value.filter(card => card.location !== 'bottom');

                    // 退出牌組選擇模式
                    isCardSetSelectionMode.value = false;

                    // 設置當前回合為選中的回合
                    currentRound.value = selectedRoundIndex;

                    // 重置抽牌相關狀態
                    draggedCount.value = 0;
                    isClickedCount.value = 0;

                    // 洗牌
                    const shuffledTexts = shuffleArray([...availableTexts]);
                    // 產生新卡片
                    const newCards = shuffledTexts.map((t, i) => ({
                        id: cardIndex.value + i + 1,
                        number: i + 1,
                        isFlipped: true,
                        location: 'bottom',
                        frontText: t.front,
                        backText: t.back,
                        touchX: null,
                        touchY: null,
                        isDragging: false,
                        isClicked: false,
                        zIndex: 0,
                        card_back_background_image: round.card_back_background_image,
                        card_face_background_image: round.card_face_background_image
                    }));
                    cardIndex.value += newCards.length;
                    cards.value = [...cards.value, ...newCards];

                    // 更新區域高度
                    area_grid_heigh.value = round.area_grid_heigh;

                    // 更新狀態顯示
                    roundStatus.value = `加抽模式：第 ${selectedRoundIndex + 1} 副牌，請選擇 ${extraDrawCount.value} 張牌至中心區塊`;

                    // 標記進入加抽模式
                    isExtraDrawMode.value = true;
                    // 記錄目前加抽的回合索引
                    extraDrawRoundIndex.value = selectedRoundIndex;

                    // 清除卡片緩存
                    if (boxCardsCache) {
                        Object.keys(boxCardsCache).forEach(key => delete boxCardsCache[key]);
                    }
                };

                const endExtraDraw = () => {
                    isExplorerNowVisible.value = true;
                    isExtraDrawMode.value = false;
                    isCardSetSelectionMode.value = false;
                    roundStatus.value = "加抽結束!";
                    // 不清空 bottom，保留加抽紀錄
                    //ExtraWriteLog();
                };

                const ExtraWriteLog = () => {
                    // 取得本次加抽的 center 卡片
                    const extraCards = cards.value
                        .filter(item => item.isFlipped === false && item.location === 'center')
                        .map(item => ({
                            "number": item.number,
                            "location": item.location,
                            "location_name": locations[item.location],
                            "frontText": item.frontText,
                            "backText": item.backText,
                        }))
                        .sort((a, b) => a.number - b.number);

                    // 記錄已加抽過的卡片
                    if (!extraDrawUsedCards.value[extraDrawRoundIndex.value]) {
                        extraDrawUsedCards.value[extraDrawRoundIndex.value] = new Set();
                    }
                    extraCards.forEach(item => {
                        extraDrawUsedCards.value[extraDrawRoundIndex.value].add(`${item.frontText}|${item.backText}`);
                    });

                    // 寫入資料庫
                    if (!db.value) return;
                    const transaction = db.value.transaction(['Records'], 'readwrite');
                    const objectStore = transaction.objectStore('Records');
                    const getRequest = objectStore.get(sessionKey.value);

                    getRequest.onsuccess = (event) => {
                        let sessionData = event.target.result;
                        if (sessionData) {
                            // 只將新加抽的卡片 push 到最後一筆 operation.cards
                            let lastOperation = sessionData.operations[sessionData.operations.length - 1];
                            if (!lastOperation.cards) lastOperation.cards = [];
                            // 過濾掉已經存在的卡片，只新增未出現過的
                            const existingKeySet = new Set(
                                lastOperation.cards.map(c => `${c.frontText}|${c.backText}|${c.location}`)
                            );
                            const newCards = extraCards.filter(
                                c => !existingKeySet.has(`${c.frontText}|${c.backText}|${c.location}`)
                            );
                            lastOperation.cards.push(...newCards);

                            // 更新資料庫
                            const putRequest = objectStore.put(sessionData);
                            putRequest.onsuccess = () => {};
                        } else {
                            // 若沒有原始紀錄則新建
                            addOperation(extraCards);
                        }
                    };
                }

                // 返回所有方法和變數
                return {
                    cards,
                    cardsInBox,
                    flipCard,
                    dragCard,
                    dropCard,
                    cardStyle,
                    bottomCardStyle,
                    roundStatus,
                    clickCard,
                    dragOver,
                    SubmitText,
                    ModifySubmitText, 
                    exportDatabase,
                    clearDatabase,
                    cardBgStyle,
                    explorerNow,
                    refreshPage,
                    addExtraCards,
                    isExplorerNowVisible,
                    isCardSetSelectionMode, // 添加新狀態到返回值
                    selectSubject,
                    textareaContent,
                    gender,
                    cus_name,
                    area_grid_heigh,
                    boxClickSelectCard,
                    currentTime,
                    hasSelectedBox,
                    zodiacBoxes,
                    remainingCardCount, // 新增計算屬性輸出
                    extraDrawCount, // 可由外部調整加抽數量
                    isExtraDrawMode, // 加入到返回值，供模板判斷
                    endExtraDraw, // 新增結束加抽的函數
                };
            }
        }).mount('#app');
    </script>
    <!-- 添加 Bootstrap JS 和 Popper -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>