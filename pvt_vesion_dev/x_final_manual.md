# `x_final.html` 綜合說明手冊

## 1. 簡介

本文件旨在提供「紫微牌抽卡應用」 (`x_final.html`) 的全面指南，內容涵蓋使用者操作、遊戲規則、開發技術細節及系統流程。無論您是使用者、管理員或開發人員，本手冊都將協助您深入了解此應用。

此應用是一個基於 Web 的互動式抽卡工具，使用者可以透過模擬抽牌與放牌的過程，進行問事占卜。系統會引導使用者完成多個回合的抽牌，並記錄其操作歷程，最終產出占卜結果。

---

## 2. 操作手冊

### 2.1 遊戲規則

#### 2.1.1 提問規則

- **一事一問**：每一組牌（即一次完整的流程）只能問一個問題。若要問衍生問題或新問題，需重新開始一局。
- **問題明確**：問題務必清楚、精準，最好設定明確的時間範圍。
  - **佳例**：我三個月內會不會有好桃花？ / 我半年內是否有升遷的可能？
- **結果回饋**：若占問的事情有了結果，建議給予回饋，以利牌義分析與驗證。
- **不受理問題**：健康、失物、賭博、代問他人之事...等問題，將不予回答。
- **先有想法**：提問前，自己最好先有想法或已做過努力，占卜結果會更精確。

#### 2.1.2 抽牌規則

1.  **總共四輪**：總共會進行四輪抽牌，共抽出 8 張牌。
2.  **第一輪**：從 14 張主星牌中抽出 2 張，並將其放置到 12 宮位中的任意位置。
3.  **第二輪**：從 14 張副星牌中抽出 2 張，放置規則同上。
4.  **第三輪**：從 32 張乙級星牌中抽出 3 張，放置規則同上。
5.  **第四輪**：從 12 張長生十二神牌中抽出 1 張，放置規則同上。
6.  **位置可重複**：不同輪抽出的牌，可以放置在同一個宮位。

### 2.2 操作流程

1.  **開啟頁面**：在瀏覽器中開啟 `x_final.html`。
2.  **填寫問題**：
    -   在畫面中央的表單區域，依序選擇「性別」、輸入「姓名」、選擇「主題」。
    -   在「問題描述」文字框中，詳細說明您想問的人、事、時、地、物。
    -   填寫完畢後，點擊 **`確認`** 按鈕。點擊後，問題區將被鎖定，無法修改。
3.  **開始抽牌**：
    -   點擊確認後，第一輪的牌會出現在畫面下方的「抽牌區」。
    -   系統會提示該回合需要抽幾張牌（例如：「第一回合，請選擇 2 張牌」）。
4.  **選牌與放牌**：
    -   在下方抽牌區 **點擊** 您要選擇的卡牌，被選中的卡牌會向上浮動。
    -   選擇完畢後，**點擊** 上方的 12 宮位（子、丑、寅...等），即可將選中的第一張牌放置進去。
    -   重複此動作，直到該回合所有抽出的牌都已放置完畢。
5.  **進行後續回合**：
    -   完成一輪後，系統會自動開始下一輪，下方抽牌區會更新為新一輪的牌。
    -   重複步驟 4，直到所有回合結束。
6.  **完成與匯出**：
    -   所有回合結束後，畫面會顯示「所有回合已完成」。
    -   此時下方會出現 **`匯出本次操作紀錄`**、**`再抽一次`** 與 **`加抽`** 按鈕。
    -   點擊 **`匯出本次操作紀錄`**，系統會將本次所有的操作（問題、抽牌、放牌順序）匯出成一個文字檔（`.txt`），您可以將此檔案提供給解牌師。
7.  **加抽功能**：
    -   若在主要流程後需要補充問題，可點擊 **`加抽`** 按鈕。
    -   系統會提供不同牌組供選擇，選擇後即可從下方抽牌區選牌，並放置到宮位中。
    -   加抽結束後，點擊 **`結束加抽`**，然後同樣可以匯出紀錄。

---

## 3. 開發手冊

### 3.1 技術棧

-   **前端框架**：Vue.js 3 (Composition API)
-   **UI 框架**：Bootstrap 5
-   **互動效果**：SweetAlert2
-   **本地儲存**：IndexedDB (用於暫存操作紀錄)
-   **語言**：HTML, CSS, JavaScript

### 3.2 程式邏輯

#### 3.2.1 核心概念

本應用程式的核心是圍繞著 **回合 (Round)**、**卡牌 (Card)** 與 **狀態 (State)** 進行。

-   **狀態管理**：使用 Vue 3 的 `ref`、`reactive` 和 `computed` 進行響應式狀態管理。所有使用者互動（如點擊、拖放）都會更新相關的狀態變數，從而自動重新渲染畫面。
-   **回合制系統**：遊戲流程由一個名為 `rounds` 的陣列驅動。此陣列定義了每一回合的總牌數、應抽牌數、牌的文字內容以及牌背/牌面圖片。`currentRound` 變數則用來追蹤當前的回合進度。
-   **事件驅動**：整個操作流程是事件驅動的。例如，`@click` 用於選牌和放牌，`@dragstart` 和 `@drop` 處理拖放邏輯（雖然目前主要以點擊操作為主）。

#### 3.2.2 主要資料結構

-   **`rounds` (Reactive Array)**
    ```javascript
    const rounds = reactive([
        { 
            area_grid_heigh:"150", 
            card_back_background_image:"images/back3.jpg", 
            card_face_background_image:"images/face10.jpg", 
            totalCards: 14, 
            drawCount: 2, 
            texts: [ { "front": "紫微", "back": "主星" }, ... ]
        },
        // ... more rounds
    ]);
    ```
    -   `area_grid_heigh`: 底部抽牌區的高度。
    -   `card_back_background_image`: 該回合卡牌的牌背圖片路徑。
    -   `card_face_background_image`: 該回合卡牌的牌面圖片路徑。
    -   `totalCards`: 該回合總牌數。
    -   `drawCount`: 該回合應抽牌數。
    -   `texts`: 該回合每張牌的牌面與牌背文字。

-   **`cards` (Ref Array)**: 儲存當前畫面上所有卡牌物件的陣列。每個卡牌物件包含 `id`, `number`, `frontText`, `backText`, `boxId` (所在位置), `isFlipped` (是否翻面) 等屬性。

-   **`operations` (Ref Array)**: 記錄使用者每一步操作的陣列，用於最後的匯出功能。

#### 3.2.3 主要函式說明

-   **`initRound()`**: 初始化一個回合。根據 `currentRound` 的值，從 `rounds` 陣列中取得設定，生成該回合的卡牌，洗牌後顯示在下方抽牌區。
-   **`SubmitText()`**: 當使用者點擊「確認」按鈕後觸發。此函式會記錄使用者填寫的問題、姓名等資訊，鎖定輸入框，並呼叫 `initRound()` 開始第一回合。
-   **`clickCard(card)`**: 在下方抽牌區點擊卡牌時觸發。處理卡牌的選取邏輯，若選取數量未達該回合上限，則將卡牌設定為 `isClicked` 狀態。
-   **`boxClickSelectCard(boxId)`**: 點擊上方宮位時觸發。此函式會將最近一張被 `clickCard` 選中的牌，移動到指定的 `boxId` 宮位中，並記錄此操作。
-   **`nextRound()`**: 當一個回合的牌都放置完畢後自動觸發，用於推進到下一個回合。
-   **`explorerNow()`**: 匯出操作紀錄。此函式會遍歷 `operations` 陣列，將其格式化為人類可讀的文字，並觸發瀏覽器下載 `.txt` 檔案。
-   **`addExtraCards()` / `endExtraDraw()`**: 處理「加抽」模式的進入與退出。

### 3.3 應用程式流程圖

以下為使用 Mermaid 語法繪製的系統主要流程圖。

```mermaid
graph TD
    A[開始/載入頁面] --> B{填寫問題表單};
    B --> C[點擊「確認」按鈕];
    C --> D[初始化第一回合 initRound()];
    D --> E{下方抽牌區顯示卡牌};
    E --> F[使用者點擊選牌 clickCard()];
    F --> G{卡牌是否已選足夠數量?};
    G -- 否 --> F;
    G -- 是 --> H[使用者點擊宮位放牌 boxClickSelectCard()];
    H --> I{本回合牌是否已放完?};
    I -- 否 --> H;
    I -- 是 --> J{是否所有回合都已完成?};
    J -- 否 --> K[推進到下一回合 nextRound()];
    K --> D;
    J -- 是 --> L[顯示「完成」與功能按鈕];
    L --> M[點擊「匯出紀錄」 explorerNow()];
    L --> N[點擊「再抽一次」 refreshPage()];
    L --> O[點擊「加抽」 addExtraCards()];
    M --> P[產生並下載TXT檔];
    N --> A;
    O --> Q{選擇加抽牌組};
    Q --> R[重複選牌放牌流程];
    R --> S[點擊「結束加抽」];
    S --> L;
```
